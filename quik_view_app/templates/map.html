{% extends 'index.html' %}
{% block title %} Quikr Ad Mapper {% endblock %}
{% block main_content%}
<body>
  <h1 style="margin: 0px auto; text-align: center;" id="head_trend">Ad Location Visualizer on Quikr</h1>
  <h5><a href="/">Go Back</a></h5>
  <p>
    Please Select the City in the floating panel.
  </p>
  <div id="map"></div>
  <style>
    #map{
      width: 100%;
      height:100vh;
      background-color: #CCC;
    }
    #floating-panel {
      position: fixed;
      right: 10px;
      top: 50%;
      z-index: 5;
      background-color: #fff;
      padding: 5px;
      border: 1px solid #999;
      text-align: center;
      font-family: 'Roboto','sans-serif';
      line-height: 30px;
      padding-left: 10px;
    }
  </style>
  <div id="floating-panel">
    <div>
      <label for="city">City</label>
      <select id="city_name" name="city_name">
      {% for city in city_list %}
        <option value="{{city.2}},{{city.3}}"> {{city.0}} </option>
      {% endfor %}
      </select>
    </div>
    <button id="update_button">Update</button>
  </div>
  <script src="https://maps.googleapis.com/maps/api/js"></script>
  <script>
    console.log("Loaded");
    var map = 0;
    var marker_list = [];
    function initialize() {
      var mapCanvas = document.getElementById('map');
      var sc = $('#city_name').val().split(',');
      console.log(sc);
      var cent = {'lat': parseFloat(sc[0]), 'lng': parseFloat(sc[1])}
      console.log(cent);
      var mapOptions = {
        center: cent,
        zoom: 7,
        mapTypeId: google.maps.MapTypeId.ROADMAP
      }
      map = new google.maps.Map(mapCanvas, mapOptions);
      get_all_ads_in_loc(cent);
    }
    console.log('check');
    function add_markers(re) {
      for(var i = 0; i < re['docs'].length; i++) {
        var ad = re['docs'][i];
        var marker = new google.maps.Marker({
          position: {'lat' : ad['lat'], 'lng' : ad['lng']},
          map: map,
          title: ad['t']
        });
        marker_list.push(marker);
      }
    }
    function get_sync_total(geopos) {
      var ret = 0;
      $.ajax({
        data : {
          'lat' : geopos['lat'],
          'lon' : geopos['lng'],
          'from' : 0,
          'size' : 1
        },
        url : '/get_loc_ad/',
        type: 'GET',
        async : false,
        success : function(re, status, xhr) {
          console.log("Sync Query = ");
          console.log(re);
          ret = parseInt(re['total']);
        }
      });
      return ret;
    }
    function get_all_ads_in_loc(geopos) {
      console.log('Getting Adds');
      var data = {};
      var from = 0;
      var total = get_sync_total(geopos);
      var jump = Math.round(total / 10);
      console.log('Total Obtained Sync = ' + total + 'jump = ' + jump);
      while(from < total)
      {
        from += jump;
        console.log('from = ' + from);
        var temp_from = Math.round((Math.random() * 1000000) + 1);
        console.log("temp = " + temp_from);
        $.ajax({
          data : {
            'lat' : geopos['lat'],
            'lon' : geopos['lng'],
            'from' : from, //from - 100,
            'size' : 10
          },
          url : '/get_loc_ad/',
          type: 'GET',
          async : true,
          success : function(re, status, xhr) {
            console.log(re);
            if(status == "success") {
              add_markers(re);
              if(total == -1) {
                var tot = parseInt(re['total']);
                if(tot < 1000) total = tot; else total = 1000;
              }
            }
            else console.log("Unable to Get Some Markers");
          }
        });
      }
    }
    $('#update_button').click(initialize);
    console.log('test');
    $(initialize);
    google.maps.event.addDomListener(window, 'load', initialize);
  </script>
{% endblock %}
